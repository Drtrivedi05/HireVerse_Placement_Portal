<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Posts - HIreVerse Company</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  {% load static %}
  <link rel="stylesheet" href="{% static 'sidebar.css' %}">
  <style>
    body { background: #f4f6f8; }
    .main-content { margin-left: 240px; padding: 2rem; }
    .job-posts-section { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 2rem; }
    .job-post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; }
    .job-post-header h2 { font-size: 1.5rem; font-weight: 600; color: #007bff; }
    .job-card { border: 1px solid #e3e3e3; transition: box-shadow 0.2s; }
    .job-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.10); border-color: #b3d1ff; }
    @media (max-width: 768px) { .main-content { margin-left: 0; padding: 1rem; } .sidebar { position: static; width: 100%; min-height: auto; } }
  </style>
</head>
<body>
  <div class="sidebar d-flex flex-column justify-content-between"
     style="
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 240px;
        background: #ffffff;
        box-shadow: 2px 0 8px rgba(0,0,0,0.05);
        padding: 20px 0;
        z-index: 1000;
     ">

    <!-- Logo Section -->
    <div style="text-align: center; margin-bottom: 20px;">
      {% load static %}
      <img src="{% static 'assets/logo_main.png' %}" 
          alt="HireVerse Logo" 
          style="width: 180px; height: auto; object-fit: contain;">
    </div>

    <!-- Navigation Links -->
    <nav class="nav flex-column" style="padding: 0 15px; flex-grow: 1;">
      <a class="nav-link" href="/companyDashboard"
        style="color: #007bff; font-weight: 500;
                font-size: 1.05rem; margin-bottom: 12px; padding: 10px 12px;
                border-radius: 8px; display: flex; align-items: center; 
                gap: 8px; text-decoration: none; transition: 0.2s;">
        <i class="bi bi-speedometer2 me-2"></i> Dashboard
      </a>

      <a class="nav-link" href="/companyProfile"
        style="color: #007bff; font-weight: 500; font-size: 1.05rem;
                margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                display: flex; align-items: center; gap: 8px; text-decoration: none;
                transition: 0.2s;"
        onmouseover="this.style.backgroundColor='#e9f5ff'; this.style.color='#0056b3';"
        onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';">
        <i class="bi bi-person-circle me-2"></i> Profile
      </a>

      <a class="nav-link active" href="/companyJobPosts"
        style="background: #e9f5ff; color: #0056b3; font-weight: 600; font-size: 1.05rem;
                margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                display: flex; align-items: center; gap: 8px; text-decoration: none;
                transition: 0.2s;"
        onmouseover="this.style.backgroundColor='#e9f5ff'; this.style.color='#0056b3';"
        onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';">
        <i class="bi bi-briefcase me-2"></i> Posts
      </a>

      <a class="nav-link" href="/companySelectionTest"
        style="color: #007bff; font-weight: 500; font-size: 1.05rem;
                margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                display: flex; align-items: center; gap: 8px; text-decoration: none;
                transition: 0.2s;"
        onmouseover="this.style.backgroundColor='#e9f5ff'; this.style.color='#0056b3';"
        onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';">
        <i class="bi bi-file-earmark-text me-2"></i> Selection
      </a>

      <a class="nav-link" href="/companyEvaluateTest"
        style="color: #007bff; font-weight: 500; font-size: 1.05rem;
                margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                display: flex; align-items: center; gap: 8px; text-decoration: none;
                transition: 0.2s;"
        onmouseover="this.style.backgroundColor='#e9f5ff'; this.style.color='#0056b3';"
        onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';">
        <i class="bi bi-clipboard-check me-2"></i> Evaluate
      </a>

      <a class="nav-link" href="/companyReport"
        style="color: #007bff; font-weight: 500; font-size: 1.05rem;
                margin-bottom: 12px; padding: 10px 12px; border-radius: 8px;
                display: flex; align-items: center; gap: 8px; text-decoration: none;
                transition: 0.2s;"
        onmouseover="this.style.backgroundColor='#e9f5ff'; this.style.color='#0056b3';"
        onmouseout="this.style.backgroundColor='transparent'; this.style.color='#007bff';">
        <i class="bi bi-bar-chart me-2"></i> Reports
      </a>
    </nav>

    <!-- Logout Button (Bottom Fixed) -->
    <a class="nav-link" href="{% url 'logout' %}"
      style="
          color: #dc3545; 
          font-weight: 600; 
          font-size: 1.05rem; 
          padding: 10px 12px; 
          border-radius: 8px; 
          display: flex; align-items: center; gap: 8px;
          text-decoration: none; 
          transition: 0.2s; 
          border-top: 1px solid #f0f0f0; 
          justify-content: center;
          margin-top: auto;
      "
      onmouseover="this.style.backgroundColor='#ffe6e9'; this.style.color='#b02a37';"
      onmouseout="this.style.backgroundColor='transparent'; this.style.color='#dc3545';">
      <i class="bi bi-box-arrow-right me-2"></i> Logout
    </a>

  </div>


  <div class="main-content">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="job-posts-section">
      <div class="job-post-header">
        <h2>Job Postings</h2>
        <button class="btn btn-primary d-flex align-items-center" style="font-weight:500; border-radius:8px;" data-bs-toggle="modal" data-bs-target="#jobModal" onclick="openAddJobModal()">
          <i class="bi bi-briefcase me-2"></i> Add Job Post
        </button>
      </div>

      <div class="d-flex flex-wrap gap-4">
        {% for job in jobs %}
        <div class="job-card bg-white p-4 rounded-4 shadow-sm flex-grow-1" style="min-width:340px;max-width:500px;">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h3 class="fw-bold mb-1">{{ job.JOB_TITLE }}</h3>
              <div class="text-secondary mb-2">{{ job.JOB_TYPE }} | {{ job.JOB_LOCATION }}</div>
            </div>
            <span class="badge rounded-pill border border-primary text-primary px-3 py-2" style="background:#fff;">{{ job.JOB_VACANCY }} Vacancy </span>
          </div>
          <div class="mb-3 text-secondary" style="font-size:1.1rem;">Posted on: {{ job.JOB_POSTED_DATE }}</div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" style="border-radius:8px;"
              onclick="openEditJobModal({{ job.JOB_ID }}, '{{ job.JOB_TITLE|escapejs }}', '{{ job.JOB_LOCATION|escapejs }}', '{{ job.JOB_TYPE }}', '{{ job.JOB_STATUS }}', {{ job.JOB_VACANCY }}, {{ job.JOB_SALARY }}, '{{ job.JOB_DESCRIPTION|escapejs }}')">
              Edit
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#viewApplicantsModal" data-job-id="{{ job.JOB_ID }}">
              View Applicants
            </button>
          </div>
        </div>
        {% empty %}
          <div class="text-secondary">No job posts found.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Add/Edit Job Modal -->
  <div class="modal fade" id="jobModal" tabindex="-1" aria-labelledby="jobModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="jobModalLabel">Add Job Post</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="POST" id="jobForm">
            {% csrf_token %}
            <input type="hidden" id="jobId" name="jobId" value="">
            <div class="mb-3">
              <label for="jobTitle" class="form-label">Job Title</label>
              <input type="text" class="form-control" id="jobTitle" name="jobTitle" required>
            </div>
            <div class="mb-3">
              <label for="jobLocation" class="form-label">Location</label>
              <input type="text" class="form-control" id="jobLocation" name="jobLocation" required>
            </div>
            <div class="mb-3">
              <label for="jobType" class="form-label">Type</label>
              <select class="form-select" id="jobType" name="jobType" required>
                <option value="Internship">Internship</option>
                <option value="Full Time">Full Time</option>
                <option value="PPO">Internship With Full Time(Pre Placement Offer)</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="jobStatus" class="form-label">Status</label>
              <select class="form-select" id="jobStatus" name="jobStatus" required>
                <option value="Open">Open</option>
                <option value="Close">Close</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="jobVacancy" class="form-label">Vacancy</label>
              <input type="number" class="form-control" id="jobVacancy" name="jobVacancy" min="0">
            </div>
            <div class="mb-3">
              <label for="jobSalary" class="form-label">Package(in LPA)</label>
              <input type="number" class="form-control" id="jobSalary" name="jobSalary" min="0" step="0.01">
            </div>
            <div class="mb-3">
              <label for="jobDescription" class="form-label">Description</label>
              <textarea class="form-control" id="jobDescription" name="jobDescription" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="jobSubmitBtn">Add Job</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- View Applicants Modal -->
  <div class="modal fade" id="viewApplicantsModal" tabindex="-1" aria-labelledby="viewApplicantsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewApplicantsModalLabel">Applicants</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="applicantsList">
          <div class="text-secondary">Loading applicants...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function openAddJobModal() {
        document.getElementById('jobForm').reset();
        document.getElementById('jobId').value = '';
        document.getElementById('jobModalLabel').innerText = "Add Job Post";
        document.getElementById('jobSubmitBtn').innerText = "Add Job";
    }

    function openEditJobModal(id, title, location, type, status, vacancy, salary, description) {
        document.getElementById('jobId').value = id;
        document.getElementById('jobTitle').value = title;
        document.getElementById('jobLocation').value = location;
        document.getElementById('jobType').value = type;
        document.getElementById('jobStatus').value = status;
        document.getElementById('jobVacancy').value = vacancy;
        document.getElementById('jobSalary').value = salary;
        document.getElementById('jobDescription').value = description;
        document.getElementById('jobModalLabel').innerText = "Edit Job Post";
        document.getElementById('jobSubmitBtn').innerText = "Update Job";
        var jobModal = new bootstrap.Modal(document.getElementById('jobModal'));
        jobModal.show();
    }

    document.addEventListener('DOMContentLoaded', function() {
      var viewApplicantsModal = document.getElementById('viewApplicantsModal');
      viewApplicantsModal.addEventListener('show.bs.modal', function(event) {
        var button = event.relatedTarget;
        var jobId = button.getAttribute('data-job-id');

        fetch(`/companyJobPosts/${jobId}/applicants/`)
        .then(res => res.json())
        .then(data => {
          let html = '';
          if (data.length === 0) {
            html = '<div class="text-secondary">No applicants found.</div>';
          } else {
            html = `
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>College</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
            `;
            data.forEach(app => {
              html += `
                <tr>
                  <td>${app.name}</td>
                  <td>${app.email}</td>
                  <td>${app.college}</td>
                  <td>${app.status}</td>
                </tr>
              `;
            });
            html += '</tbody></table>';
          }
          document.getElementById('applicantsList').innerHTML = html;
        });
      });
    });
  </script>

  <!-- =============================== -->
  <!-- ðŸ”„ Loading Animation Overlay -->
  <!-- =============================== -->
  <style>
    /* --- Overlay Styling --- */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    #loadingOverlay.show {
      display: flex;
      opacity: 1;
    }

    /* Spinner */
    .spinner-border {
      width: 4rem;
      height: 4rem;
      color: #007bff;
    }

    /* Text */
    .loading-text {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #007bff;
      font-weight: 600;
      text-align: center;
    }

    /* Fade animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border" role="status"></div>
      <div class="loading-text">Posting your job... Please wait</div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const forms = document.querySelectorAll('form');
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = overlay.querySelector('.loading-text');

      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          // Detect which form submitted
          const button = form.querySelector('button[type="submit"]');
          let label = 'Processing...';
          if (button && button.innerText.trim() !== '') {
            label = button.innerText.trim();
          }

          // Update loading text dynamically
          loadingText.innerText = `${label} Please wait...`;

          // Show overlay with fade effect
          overlay.classList.add('show');

          // Disable the button to prevent double submit
          if (button) button.disabled = true;
        });
      });

      // Optional safeguard
      window.addEventListener('beforeunload', () => {
        overlay.classList.remove('show');
      });
    });
  </script>

</body>
</html>
